<!DOCTYPE html>
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <meta charset="UTF-8">

</head>

<script>

async function getIP() {
    const savedValue = localStorage.getItem('userInput');
    if (savedValue) {
        console.log(`Valore recuperato: ${savedValue}`);
        return savedValue;
    }
    return null;
}

async function loadDoc() {
    try {
        const IP = await getIP(); // Attendere il valore IP prima di eseguire il fetch

        if (IP) {
            const response1 = await fetch(`http://${IP}/single_api/airQuality?ApplicationKey=oqwg-dash-jkbc-phuw-qgey-bhas-dapp`);
            const data1 = await response1.json();
            document.getElementById("airQuality").innerHTML = data1.value + " pm";
            updateProgressBar("airQualityProgress", data1.value, 0, 100);

            const response2 = await fetch(`http://${IP}/single_api/humidity?ApplicationKey=oqwg-dash-jkbc-phuw-qgey-bhas-dapp`);
            const data2 = await response2.json();
            document.getElementById("humidity").innerHTML = data2.value + "%";
            updateProgressBar("humidityProgress", data2.value, 0, 100);

            const response3 = await fetch(`http://${IP}/single_api/temperature?ApplicationKey=oqwg-dash-jkbc-phuw-qgey-bhas-dapp`);
            const data3 = await response3.json();
            document.getElementById("temperature").innerHTML = data3.value + "°";
            updateProgressBar("temperatureProgress", data3.value, 0, 100);

            const response4 = await fetch(`http://${IP}/single_api/light?ApplicationKey=oqwg-dash-jkbc-phuw-qgey-bhas-dapp`);
            const data4 = await response4.json();
            document.getElementById("light").innerHTML = data4.value + " lm";
            updateProgressBar("lightProgress", data4.value, 0, 500);

        } else {
            console.error('IP non trovato nel localStorage.');
        }
    } catch (error) {
        console.error('Error loading data:', error);
        document.getElementById("light").innerHTML = "IP o N° porta errati";
        document.getElementById("temperature").innerHTML = "IP o N° porta errati";
        document.getElementById("humidity").innerHTML = "IP o N° porta errati";
        document.getElementById("airQuality").innerHTML = "IP o N° porta errati";

    }
}
    async function meteo() {
        try {
            const response = await fetch('http://"+IP+"/single_api/weather?key=ApplicationKey=oqwg-dash-jkbc-phuw-qgey-bhas-dapp');
            const data = await response.json();
            document.getElementById("weather").innerHTML = data.value;
        } catch (error) {
            console.error('Error loading data:', error);
        }
    }

    function updateProgressBar(elementId, value, min, max) {
        const progressBar = document.getElementById(elementId);
        const percentage = ((value - min) / (max - min)) * 100;
        progressBar.style.width = percentage + '%';
    }

    let intervallo_parametri = setInterval(() => {
        loadDoc();
    }, 5000);

    let intervallo_meteo = setInterval(() => {
        meteo();
    }, 180000);
</script>

<body>
<body>

<nav class="navbar bg-body-tertiary" data-bs-theme="dark">
    <div class="container">
        <a class="navbar-brand" href="#">
            <img src="ovv-Logo_3.png" alt="Bootstrap" width="30" height="24">
            OVVwebApp
        </a>
    </div>
</nav>

<div class="position-absolute top-12 start-0">
    <div class="shadow bg-body-tertiary rounded card mt-2 ms-3" style="width: 11rem;">
        <center>
            <div>
                <span style="font-weight: bold; font-size: 40px" id="humidity"></span>
            </div>
        </center>
        <div class="card-body">
            <p class="text-center fs-1 fw-bold">Umidit&agrave</p>
            <div class="progress" role="progressbar" aria-label="Umidita" aria-valuemin="40" aria-valuemax="60">
                <div class="progress-bar bg-primary" id="humidityProgress" style="width: 50%"></div>
            </div>
        </div>
    </div>
</div>

<div class="position-absolute top-12 end-0">
    <div class="shadow bg-body-tertiary rounded card mt-2 me-3" style="width: 11rem;">
        <center>
            <div>
                <span style="font-weight: bold; font-size: 40px" id="temperature"></span>
            </div>
        </center>
        <div class="card-body">
            <p class="text-center fs-2 fw-bold mt-1">Temperatura</p>
            <div class="progress" role="progressbar" aria-label="Temp" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100">
                <div class="progress-bar bg-success" id="temperatureProgress" style="width: 25%"></div>
            </div>
        </div>
    </div>
</div>

<div class="position-absolute top-50 start-50 translate-middle">
    <div class="container text-center">
        <div class="row">
            <div class="col">
                <div class="shadow bg-body-tertiary rounded card mt-4" style="width: 16rem;">
                    <div class="card-body">
                        <p class="text-center fs-2 fw-bold mt-1">Meteo</p>
                        <span class="badge text-bg-info" id="weather"></span>
                    </div>
                </div>
            </div>
            <div class="col">
                <center>
                    <div class="shadow bg-body-tertiary rounded card mt-4" onclick="location.href='paginaErrori.html'" style="width: 11rem;">
                        <center>
                            <div class="spinner-grow text-danger mt-4" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </center>
                        <div class="card-body">
                            <p class="text-center fs-2 fw-bold mt-1">Avvisi</p>
                            <span class="badge text-bg-danger" id="avviso">Nesssun avviso</span>
                        </div>
                    </div>
                </center>
            </div>
        </div>
    </div>
</div>


<div class="position-absolute bottom-0 start-0">
    <div class="shadow bg-body-tertiary rounded card mb-4 ms-3" style="width: 11rem;">
        <center>
            <div>
                <span style="font-weight: bold; font-size: 40px" id="light"></span>
            </div>
        </center>
        <div class="card-body">
            <p class="text-center fs-1 fw-bold">Luce</p>
            <div class="progress" role="progressbar" aria-label="Temp" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100">
                <div class="progress-bar bg-warning" id="lightProgress" style="width: 50%"></div>
            </div>
        </div>
    </div>
</div>

<div class="position-absolute bottom-0 end-0">
    <div class="shadow bg-body-tertiary rounded card mb-4 me-3" style="width: 11rem;">
        <center>
            <div>
                <span style="font-weight: bold; font-size: 40px" id="airQuality"></span>
            </div>
        </center>
        <div class="card-body">
            <p class="text-center fs-1 fw-bold">Polvere</p>
            <div class="progress" role="progressbar" aria-label="Temp" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100">
                <div class="progress-bar bg-secondary" id="airQualityProgress" style="width: 90%"></div>
            </div>
        </div>
    </div>
</div>

</body>
</html>